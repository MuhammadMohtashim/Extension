<!DOCTYPE html>
<html>
<head>
    
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agency Rating Collaborator</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .comment-card {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .like-button {
      cursor: pointer;
      color: #6c757d;
    }
    .like-button.liked {
      color: #0d6efd;
    }
    .star-rating {
      display: inline-block;
    }
    .star {
      color: #ddd;
      cursor: pointer;
      font-size: 24px;
    }
    .star.filled {
      color: #ffc107;
    }
    .agency-list-item {
      cursor: pointer;
      padding: 8px;
      margin: 4px 0;
      border-radius: 4px;
    }
    .agency-list-item:hover {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="row">
      <div class="col-12">
        <h1>Agency Rating Collaborator</h1>
        <div id="auth-container" class="mb-4">
          <div id="login-container">
            <button id="login-button" class="btn btn-primary">Sign In</button>
          </div>
          <div id="user-container" style="display: none;">
            <span id="user-email"></span>
            <button id="logout-button" class="btn btn-outline-secondary btn-sm ms-2">Sign Out</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row" id="main-content" style="display: none;">
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h5>Agencies</h5>
          </div>
          <div class="card-body">
            <div class="input-group mb-3">
              <input type="text" id="agency-search" class="form-control" placeholder="Search agencies...">
            </div>
            <div id="agency-list" class="list-group"></div>
            <button id="add-agency-button" class="btn btn-primary mt-3">Add New Agency</button>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div id="agency-details" class="card" style="display: none;">
          <div class="card-header">
            <h5 id="agency-name">Agency Name</h5>
            <div id="agency-rating" class="star-rating"></div>
            <small id="rating-count">(0 ratings)</small>
          </div>
          <div class="card-body">
            <h6>Add Your Rating</h6>
            <div id="user-rating" class="star-rating mb-3">
              <span class="star" data-value="1">★</span>
              <span class="star" data-value="2">★</span>
              <span class="star" data-value="3">★</span>
              <span class="star" data-value="4">★</span>
              <span class="star" data-value="5">★</span>
            </div>
            
            <div class="form-group mb-3">
              <label for="comment-input">Your Comment</label>
              <textarea id="comment-input" class="form-control" rows="3"></textarea>
            </div>
            
            <button id="submit-rating" class="btn btn-primary mb-4">Submit Rating</button>
            
            <h6>Top Comments</h6>
            <div id="comments-container"></div>
          </div>
        </div>

        <div id="new-agency-form" class="card" style="display: none;">
          <div class="card-header">
            <h5>Add New Agency</h5>
          </div>
          <div class="card-body">
            <div class="form-group mb-3">
              <label for="new-agency-name">Agency Name</label>
              <input type="text" id="new-agency-name" class="form-control">
            </div>
            
            <h6>Your Rating</h6>
            <div id="new-agency-rating" class="star-rating mb-3">
              <span class="star" data-value="1">★</span>
              <span class="star" data-value="2">★</span>
              <span class="star" data-value="3">★</span>
              <span class="star" data-value="4">★</span>
              <span class="star" data-value="5">★</span>
            </div>
            
            <div class="form-group mb-3">
              <label for="new-agency-comment">Your Comment</label>
              <textarea id="new-agency-comment" class="form-control" rows="3"></textarea>
            </div>
            
            <button id="submit-new-agency" class="btn btn-primary">Add Agency</button>
            <button id="cancel-new-agency" class="btn btn-outline-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDg0ACWUvUb3S6xwEdfjGKgTQmjEsulQMs",
  authDomain: "recruiter-search-c7515.firebaseapp.com",
  projectId: "recruiter-search-c7515",
  storageBucket: "recruiter-search-c7515.firebasestorage.app",
  messagingSenderId: "342601714550",
  appId: "1:342601714550:web:699bd13e200851136a4857",
  measurementId: "G-LPJ6ZNG23T"
};
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // DOM Elements
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');
    const userContainer = document.getElementById('user-container');
    const loginContainer = document.getElementById('login-container');
    const userEmail = document.getElementById('user-email');
    const mainContent = document.getElementById('main-content');
    const agencySearch = document.getElementById('agency-search');
    const agencyList = document.getElementById('agency-list');
    const agencyDetails = document.getElementById('agency-details');
    const agencyNameElement = document.getElementById('agency-name');
    const agencyRatingElement = document.getElementById('agency-rating');
    const ratingCountElement = document.getElementById('rating-count');
    const userRating = document.getElementById('user-rating');
    const commentInput = document.getElementById('comment-input');
    const submitRating = document.getElementById('submit-rating');
    const commentsContainer = document.getElementById('comments-container');
    const addAgencyButton = document.getElementById('add-agency-button');
    const newAgencyForm = document.getElementById('new-agency-form');
    const newAgencyName = document.getElementById('new-agency-name');
    const newAgencyRating = document.getElementById('new-agency-rating');
    const newAgencyComment = document.getElementById('new-agency-comment');
    const submitNewAgency = document.getElementById('submit-new-agency');
    const cancelNewAgency = document.getElementById('cancel-new-agency');
    
    // Global variables
    let currentUser = null;
    let currentAgency = null;
    let selectedRating = 0;
    let newAgencySelectedRating = 0;
    
    // Authentication
    loginButton.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    });
    
    logoutButton.addEventListener('click', () => {
      auth.signOut();
    });
    
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        userEmail.textContent = user.email;
        loginContainer.style.display = 'none';
        userContainer.style.display = 'block';
        mainContent.style.display = 'flex';
        loadAgencies();
      } else {
        currentUser = null;
        loginContainer.style.display = 'block';
        userContainer.style.display = 'none';
        mainContent.style.display = 'none';
      }
    });
    
    // Agency List Functions
    function loadAgencies() {
      db.collection('agencies').orderBy('name').get().then(snapshot => {
        agencyList.innerHTML = '';
        snapshot.docs.forEach(doc => {
          const agency = doc.data();
          const div = document.createElement('div');
          div.className = 'agency-list-item';
          div.textContent = `${agency.name} (${agency.averageRating.toFixed(1)})`;
          div.dataset.id = doc.id;
          div.addEventListener('click', () => loadAgencyDetails(doc.id));
          agencyList.appendChild(div);
        });
      });
    }
    
    agencySearch.addEventListener('input', () => {
      const searchTerm = agencySearch.value.toLowerCase();
      const items = agencyList.querySelectorAll('.agency-list-item');
      
      items.forEach(item => {
        if (item.textContent.toLowerCase().includes(searchTerm)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
    
    // Agency Details Functions
    function loadAgencyDetails(agencyId) {
      newAgencyForm.style.display = 'none';
      
      db.collection('agencies').doc(agencyId).get().then(doc => {
        if (doc.exists) {
          currentAgency = { id: doc.id, ...doc.data() };
          agencyNameElement.textContent = currentAgency.name;
          
          // Display average rating with stars
          agencyRatingElement.innerHTML = '';
          for (let i = 1; i <= 5; i++) {
            const star = document.createElement('span');
            star.className = 'star' + (i <= Math.round(currentAgency.averageRating) ? ' filled' : '');
            star.textContent = '★';
            agencyRatingElement.appendChild(star);
          }
          
          ratingCountElement.textContent = `(${currentAgency.ratingCount} ratings)`;
          
          // Reset user rating UI
          selectedRating = 0;
          const stars = userRating.querySelectorAll('.star');
          stars.forEach(star => star.classList.remove('filled'));
          commentInput.value = '';
          
          // Load comments
          loadComments(agencyId);
          
          agencyDetails.style.display = 'block';
        }
      });
    }
    
    function loadComments(agencyId) {
      db.collection('agencies').doc(agencyId).collection('comments')
        .orderBy('likes', 'desc')
        .limit(5)
        .get().then(snapshot => {
          commentsContainer.innerHTML = '';
          
          if (snapshot.empty) {
            commentsContainer.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
            return;
          }
          
          snapshot.docs.forEach(doc => {
            const comment = doc.data();
            const div = document.createElement('div');
            div.className = 'comment-card';
            
            // Display rating with stars
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
              starsHtml += `<span class="star${i <= comment.rating ? ' filled' : ''}" style="cursor: default;">★</span>`;
            }
            
            div.innerHTML = `
              <div class="d-flex justify-content-between">
                <div>
                  <div class="star-rating">${starsHtml}</div>
                  <small>${comment.userEmail || 'Anonymous'}</small>
                </div>
                <div>
                  <span class="like-button${comment.likedBy && comment.likedBy.includes(currentUser.uid) ? ' liked' : ''}" data-id="${doc.id}">
                    👍 ${comment.likes || 0}
                  </span>
                </div>
              </div>
              <p class="mt-2">${comment.text}</p>
            `;
            
            // Add event listener to like button
            const likeButton = div.querySelector('.like-button');
            likeButton.addEventListener('click', () => likeComment(agencyId, doc.id));
            
            commentsContainer.appendChild(div);
          });
        });
    }
    
    // Rating functions
    userRating.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', () => {
        selectedRating = parseInt(star.dataset.value);
        
        // Update UI
        userRating.querySelectorAll('.star').forEach(s => {
          if (parseInt(s.dataset.value) <= selectedRating) {
            s.classList.add('filled');
          } else {
            s.classList.remove('filled');
          }
        });
      });
    });
    
    newAgencyRating.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', () => {
        newAgencySelectedRating = parseInt(star.dataset.value);
        
        // Update UI
        newAgencyRating.querySelectorAll('.star').forEach(s => {
          if (parseInt(s.dataset.value) <= newAgencySelectedRating) {
            s.classList.add('filled');
          } else {
            s.classList.remove('filled');
          }
        });
      });
    });
    
    submitRating.addEventListener('click', () => {
      if (!currentUser) {
        alert('Please sign in to submit a rating.');
        return;
      }
      
      if (!selectedRating) {
        alert('Please select a rating.');
        return;
      }
      
      if (!commentInput.value.trim()) {
        alert('Please enter a comment.');
        return;
      }
      
      const comment = {
        rating: selectedRating,
        text: commentInput.value.trim(),
        userId: currentUser.uid,
        userEmail: currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        likes: 0,
        likedBy: []
      };
      
      // Add the comment
      db.collection('agencies').doc(currentAgency.id).collection('comments').add(comment)
        .then(() => {
          // Update agency rating
          const agencyRef = db.collection('agencies').doc(currentAgency.id);
          return db.runTransaction(transaction => {
            return transaction.get(agencyRef).then(agencyDoc => {
              const agency = agencyDoc.data();
              const totalRating = agency.averageRating * agency.ratingCount + selectedRating;
              const newRatingCount = agency.ratingCount + 1;
              const newAverage = totalRating / newRatingCount;
              
              transaction.update(agencyRef, {
                averageRating: newAverage,
                ratingCount: newRatingCount
              });
            });
          });
        })
        .then(() => {
          // Reset form and reload comments
          selectedRating = 0;
          userRating.querySelectorAll('.star').forEach(s => s.classList.remove('filled'));
          commentInput.value = '';
          
          loadComments(currentAgency.id);
          loadAgencies(); // Refresh the agency list to show updated rating
        })
        .catch(error => {
          console.error("Error adding comment: ", error);
          alert('Failed to submit rating. Please try again.');
        });
    });
    
    function likeComment(agencyId, commentId) {
      if (!currentUser) {
        alert('Please sign in to like comments.');
        return;
      }
      
      const commentRef = db.collection('agencies').doc(agencyId).collection('comments').doc(commentId);
      
      db.runTransaction(transaction => {
        return transaction.get(commentRef).then(commentDoc => {
          if (!commentDoc.exists) {
            throw "Comment does not exist!";
          }
          
          const comment = commentDoc.data();
          const likedBy = comment.likedBy || [];
          const currentUserIndex = likedBy.indexOf(currentUser.uid);
          
          if (currentUserIndex === -1) {
            // User hasn't liked this comment yet
            likedBy.push(currentUser.uid);
            transaction.update(commentRef, {
              likes: (comment.likes || 0) + 1,
              likedBy: likedBy
            });
          } else {
            // User already liked this comment, so unlike it
            likedBy.splice(currentUserIndex, 1);
            transaction.update(commentRef, {
              likes: Math.max((comment.likes || 0) - 1, 0),
              likedBy: likedBy
            });
          }
        });
      }).then(() => {
        loadComments(agencyId);
      }).catch(error => {
        console.error("Error updating like: ", error);
      });
    }
    
    // New Agency Functions
    addAgencyButton.addEventListener('click', () => {
      agencyDetails.style.display = 'none';
      newAgencyForm.style.display = 'block';
      newAgencyName.value = '';
      newAgencyComment.value = '';
      newAgencySelectedRating = 0;
      newAgencyRating.querySelectorAll('.star').forEach(s => s.classList.remove('filled'));
    });
    
    cancelNewAgency.addEventListener('click', () => {
      newAgencyForm.style.display = 'none';
    });
    
    submitNewAgency.addEventListener('click', () => {
      if (!currentUser) {
        alert('Please sign in to add an agency.');
        return;
      }
      
      const name = newAgencyName.value.trim();
      if (!name) {
        alert('Please enter an agency name.');
        return;
      }
      
      if (!newAgencySelectedRating) {
        alert('Please select a rating.');
        return;
      }
      
      const comment = newAgencyComment.value.trim();
      if (!comment) {
        alert('Please enter a comment.');
        return;
      }
      
      // Check if agency already exists
      db.collection('agencies').where('nameLower', '==', name.toLowerCase()).get()
        .then(snapshot => {
          if (!snapshot.empty) {
            alert('This agency already exists. Please search for it instead.');
            return Promise.reject('Agency exists');
          }
          
          // Add new agency
          return db.collection('agencies').add({
            name: name,
            nameLower: name.toLowerCase(),
            averageRating: newAgencySelectedRating,
            ratingCount: 1,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser.uid
          });
        })
        .then(agencyRef => {
          // Add initial comment
          return db.collection('agencies').doc(agencyRef.id).collection('comments').add({
            rating: newAgencySelectedRating,
            text: comment,
            userId: currentUser.uid,
            userEmail: currentUser.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            likes: 0,
            likedBy: []
          }).then(() => agencyRef.id);
        })
        .then(agencyId => {
          newAgencyForm.style.display = 'none';
          loadAgencies();
          loadAgencyDetails(agencyId);
        })
        .catch(error => {
          if (error === 'Agency exists') return;
          console.error("Error adding agency: ", error);
          alert('Failed to add agency. Please try again.');
        });
    });
  </script>
</body>
</html>